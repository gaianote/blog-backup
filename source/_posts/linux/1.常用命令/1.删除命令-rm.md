---
title: 删除命令rm
date: 2019-06-12 14:15:30
tags: linux
---
1. 删除数量巨大的文件，同时显示详细信息(`-v`)

```bash
sudo rm -rfv bolands-mills-mhcpt
```

您可以使用rm -v具有rm打印每删除的文件一行。通过这种方式，您可以看到rm确实正在删除文件。但是如果你有数十亿个文件，那么你将会看到它rm仍然有效。您将不知道已删除了多少文件以及剩下多少文件。

该工具pv可以帮助您进行进度估算。

http://www.ivarch.com/programs/pv.shtml

这里是你将如何调用rm与pv使用示例输出

$ rm -rv dirname | pv -l -s 1000 > logfile
562  0:00:07 [79,8 /s] [====================>                 ] 56% ETA 0:00:05
在这个人为的例子中，我告诉我pv有1000文件。输出pv显示562已被删除，经过时间为7秒，估计完成时间为5秒。

一些解释：

pv -l使得pv通过换行，而不是字节数
pv -s number告诉pv总数是什么，它可以给你一个估计。
最后的重定向logfile是清洁输出。否则，状态行将与来自pv的输出混淆rm -v。额外：您将拥有已删除内容的日志文件。但要注意文件会变得很大。/dev/null如果您不需要日志，也可以重定向到。
要获取文件数，可以使用此命令：

$ find dirname | wc -l
如果有数十亿个文件，这也可能需要很长时间。您也可以pv在这里使用它来查看它的数量

$ find dirname | pv -l | wc -l
278k 0:00:04 [56,8k/s] [     <=>                                              ]
278044
这里说它花了4秒钟来计算278k文件。end（278044）的确切计数是来自的输出wc -l。

如果您不想等待计数，那么您可以猜测文件数量或使用pv而无需估算：

$ rm -rv dirname | pv -l > logfile
像这样你将没有任何估计完成，但至少你会看到已经删除了多少文件。/dev/null如果您不需要日志文件，请重定向到。

鸡蛋里挑骨头：

你真的需要sudo吗？
通常rm -r足以递归删除。没必要rm -f。

## 快速删除数以亿计的文件

在业务运行时，没有制定日志清除规则，导致在日志目录下保存了大量的日志文件。在使用`rm -rf $dir`删除旧的日志时，会提示`-bash: /bin/rm: Argument list too long`,通过`ls |xargs rm -rf`也可以进行删除，但是会耗费大量的时间。在网上找到一种快速删除大量文件的方法`rsync`，有点类似`MySQL`的`truncate table`。

## 具体操作方法

```
# 先创建一个空目录
# 注意：最好是用和被清空目录的所有者(用户)去创建这个空目录，使用的命令会将空目录的权限带过去
mkdir /tmp/empty
# 清除目标目录的文件,不要忘记目录后面的`/`
rsync --delete-before -av /tmp/empty/ /var/log/target/
```

## 选项说明

```
-delete-before 接收者在传输之前进行删除操作
-a 归档模式，表示以递归方式传输文件，并保持所有文件属性
-v 详细输出模式
```

## rsync快的原因

```
rm删除内容时，将目录的每一个条目逐个删除(unlink)，需要循环重复遍历很多次；
rsync删除内容时，建立好新的空目录，替换掉老目录，不需要进行大量的遍历操作。
```

